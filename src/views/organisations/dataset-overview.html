{% from "govuk/components/breadcrumbs/macro.njk" import govukBreadcrumbs %}
{% from "govuk/components/summary-list/macro.njk" import govukSummaryList %}
{% extends "layouts/main.html" %}

{% set serviceType = 'Submit' %}
{% set pageName %}
    {{organisation.name}} - {{dataset.name}} - Dataset overview
{% endset %}

{% block beforeContent %}

{{ super() }}

{{ govukBreadcrumbs({
  items: [
    {
      text: "Home",
      href: "/"
    },
    {
      text: "Organisations",
      href: '/organisations'
    },
    {
      text: organisation.name,
      href: '/organisations/' + organisation.organisation
    },
    {
      text: dataset.name
    }
  ]
}) }}

{% endblock %}

{% set mainRows = [
  {
    key: {
      text: "Number of records"
    },
    value: {
      text: stats.numberOfRecords | default(0)
    }
  },
  {
    key: {
      text: "Number of fields supplied"
    },
    value: {
      text: stats.numberOfFieldsSupplied + '/' + stats.NumberOfExpectedFields | default(0)
    }
  },
  {
    key: {
      text: "Number of fields matched"
    },
    value: {
      text: stats.numberOfFieldsMatched + '/' + stats.NumberOfExpectedFields | default(0)
    }
  },
  {
    key: {
      text: "License"
    },
    value: {
      text: "To Do"
    }
  }  
] %}

{% set endpointRows = []%}

{% for endpoint in stats.endpoints %}
  {% set endpointRow = {
    key: {
      text: endpoint.name
    },
    value: {
      text: endpoint.endpoint
    },
    classes: 'padding-top'
  } %}
  {{ endpointRows.push(endpointRow) }}



  {% if endpoint.error %}
    {% set lastAccessedRow = {
      key: {
        text: 'Data URL last accessed'
      },
      value: {
        html: endpoint.lastAccessed + '<br><p class="govuk-error-message">There was a '+endpoint.error.code+' error accessing the data URL</p> <p class="app-inset-text__error"></p>'
      },
      classes: 'app-inset-text---error'
    } %}
  {% else %}
    {% set lastAccessedRow = {
      key: {
        text: 'Data URL last accessed'
      },
      value: {
        text: endpoint.lastAccessed
      }
    } %}
  {% endif %}


  {{ endpointRows.push(lastAccessedRow) }}

  {% set lastUpdatedRow = {
    key: {
      text: 'Data URL last updated'
    },
    value: {
      text: endpoint.lastUpdated
    }
  } %}
  {{ endpointRows.push(lastUpdatedRow) }}

{% endfor %}

{% block content %}

<div class="govuk-grid-row">
    <div class="govuk-grid-column-two-thirds">
        <span class="govuk-caption-xl">{{ organisation.name }}</span>
        <h1 class="govuk-heading-xl">{{ dataset.name }}</h1>
    </div>
</div>

{% if geometries and geometries.length %}
<div class="govuk-grid-row">
  <div class="govuk-grid-column-full">
      <section>
        <h2 class="govuk-heading-m govuk-visually-hidden">Map of dataset</h2>
        <div id="map" class="app-map" role="region" aria-label="Map illustrating {{ dataset.name }} geometries. Use your keyboard to interact with the map. For screen reader users, use the arrow keys to navigate the map and the plus and minus keys to zoom in and out."></div>
      </section>
  </div>
</div>
{% endif %}

<div class="govuk-grid-row">
  <div class="govuk-grid-column-two-thirds">
    <section>
      <h2 class="govuk-heading-m">Dataset details</h2>
      {{ govukSummaryList({ rows: mainRows }) }}

      
      <h2 class="govuk-heading-m">Endpoints</h2>

      {{ govukSummaryList({ rows: endpointRows }) }}
    </section>
  </div>
</div>

{% endblock %}

{% block scripts %}
  {{ super() }}
  {% if geometries and geometries.length %}
    <link href='https://unpkg.com/maplibre-gl@latest/dist/maplibre-gl.css' rel='stylesheet' />
    <script>
      window.serverContext = {
        containerId: 'map',
        geometries: {{ geometries | dump | safe }},
      }
    </script>
    <script src="/public/js/map.bundle.js"></script>
  {% endif %}
{% endblock %}